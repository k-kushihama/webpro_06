<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/public/students.css">
    <title>生徒情報の編集 - 塾生徒管理システム</title>
</head>
<body>
    <div class="nakami">
        <div class="header">
            <h1>生徒情報の編集</h1>
            <a href="/students/<%= item.id %>" class="createbotan">詳細に戻る</a>
        </div>

        <form action="/students/<%= item.id %>/update" method="POST">
            <div class="form">
                <label>生徒氏名</label>
                <input type="text" name="name" value="<%= item.name %>" placeholder="例：佐藤 結衣" required>
            </div>

            <div style="display: flex; gap: 20px;">
                <div class="form" style="flex: 1;">
                    <label>区分</label>
                    <select name="schoolLevel" required>
                        <option value="小学生" <%= item.schoolLevel === '小学生' ? 'selected' : '' %>>小学生</option>
                        <option value="中学生" <%= item.schoolLevel === '中学生' ? 'selected' : '' %>>中学生</option>
                        <option value="高校生" <%= item.schoolLevel === '高校生' ? 'selected' : '' %>>高校生</option>
                    </select>
                </div>
                <div class="form" style="flex: 1;">
                    <label>学年</label>
                    <select name="grade" required>
                        <% for(let i=1; i<=6; i++) { %>
                            <% let g = i + '年生'; %>
                            <option value="<%= g %>" <%= item.grade === g ? 'selected' : '' %>><%= g %></option>
                        <% } %>
                    </select>
                </div>
            </div>

            <div class="form">
                <label>学習教科（複数選択可）</label>
                <div class="kyoukanaiyou">
                    <% const allSubjects = ["国語", "数学", "英語", "理科", "社会"]; %>
                    <% allSubjects.forEach(sub => { %>
                        <label style="display: flex; align-items: center; gap: 5px; font-weight: normal; margin-bottom: 0; cursor: pointer;">
                            <input type="checkbox" name="subjects" value="<%= sub %>" 
                                   <%= item.subjects.includes(sub) ? 'checked' : '' %> style="width: 18px; height: 18px;">
                            <%= sub %>
                        </label>
                    <% }) %>
                </div>
            </div>

            <div class="form">
                <label>通塾スケジュール</label>
                <div id="schedule-container" style="display: flex; flex-direction: column; gap: 10px;">
                    <% if (item.schedules && item.schedules.length > 0) { %>
                        <% item.schedules.forEach((sch) => { %>
                            <div class="schedule-row" style="display: flex; gap: 10px; align-items: center;">
                                <select name="day" style="flex: 1;" required>
                                    <% ["月曜日", "火曜日", "水曜日", "木曜日", "金曜日", "土曜日", "日曜日"].forEach(d => { %>
                                        <option value="<%= d %>" <%= sch.day === d ? 'selected' : '' %>><%= d %></option>
                                    <% }) %>
                                </select>
                                <input type="text" name="time" value="<%= sch.time %>" placeholder="例：18:00" style="flex: 1;" required>
                                <button type="button" class="delete-row-btn" style="background: none; border: none; color: #ff0000; cursor: pointer; font-size: 20px; padding: 0 5px;">&times;</button>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="schedule-row" style="display: flex; gap: 10px; align-items: center;">
                            <select name="day" style="flex: 1;" required>
                                <% ["月曜日", "火曜日", "水曜日", "木曜日", "金曜日", "土曜日", "日曜日"].forEach(d => { %>
                                    <option value="<%= d %>"><%= d %></option>
                                <% }) %>
                            </select>
                            <input type="text" name="time" placeholder="例：18:00" style="flex: 1;" required>
                            <button type="button" class="delete-row-btn" style="background: none; border: none; color: #ff0000; cursor: pointer; font-size: 20px; padding: 0 5px;">&times;</button>
                        </div>
                    <% } %>
                </div>
                <div style="margin-top: 12px;">
                    <button type="button" id="add-schedule" class="createbotan" style="width: 100%; background-color: #fcfcfc; border: 1px dashed #999; height: 40px;">＋ 新しいコマを追加する</button>
                </div>
                <p style="font-size: 11px; color: #888; margin-top: 5px;">※ スケジュールは最大7コマまで設定可能です．</p>
            </div>

            <div class="form" style="display: flex; align-items: center; gap: 10px; height: 50px;">
                <input type="checkbox" name="isHighPriority" id="isHighPriority" <%= item.isHighPriority ? 'checked' : '' %> style="width: 20px; height: 20px; cursor: pointer;">
                <label for="isHighPriority" style="margin-bottom: 0; cursor: pointer;">重点指導生徒としてマークする</label>
            </div>

            <div class="form">
                <label>備考・指導メモ</label>
                <textarea name="memo" style="height: 120px;" placeholder="指導上の注意点や進捗を記入してください．"><%= item.memo %></textarea>
            </div>
            
            <div class="botanarea">
                <button type="submit" class="createbotan submitbotan" style="height: 40px; padding: 0 30px;">更新内容を保存</button>
                <a href="/students/<%= item.id %>" style="text-decoration: none;"><span class="editc">キャンセル</span></a>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('schedule-container');
            const addButton = document.getElementById('add-schedule');

            if (!container || !addButton) return;

            // コマの追加ロジック：ヒックの法則に基づき選択肢を制限
            addButton.addEventListener('click', () => {
                const rows = container.getElementsByClassName('schedule-row');
                if (rows.length >= 7) {
                    alert('スケジュールは最大7コマまで登録可能です．');
                    return;
                }

                const firstRow = rows[0];
                const newRow = firstRow.cloneNode(true);

                // 新しい行の入力値を初期化
                const input = newRow.querySelector('input');
                if (input) input.value = '';

                container.appendChild(newRow);
            });

            // コマの削除ロジック：イベントデリゲーションによる一括制御
            container.addEventListener('click', (e) => {
                // クラス名での判定により削除ボタンのみに反応させる
                if (e.target && e.target.classList.contains('delete-row-btn')) {
                    const rows = container.getElementsByClassName('schedule-row');
                    
                    // UX：最低限1つのスケジュールを維持させる制約
                    if (rows.length <= 1) {
                        alert('最低1つのスケジュールが必要です．');
                        return;
                    }
                    
                    e.target.parentElement.remove();
                }
            });
        });
    </script>
</body>
</html>